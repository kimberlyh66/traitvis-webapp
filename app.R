library(shiny)
library(ggplot2)
library(lubridate)
library(timevis)
library(leaflet)
library(cronR)
library(shinythemes)
library(scales)
library(stringr)
library(kableExtra)

source('render-site-map.R')

#cache_path <- "/srv/shiny-server/cache/cache.RData"
#cache_mod_time <- file.mtime(cache_path)
#full_cache_data <- NA

#load_cache <- function(full_cache_data) {
#    curr_mod_time <- file.mtime(cache_path)
#
#    if (curr_mod_time > cache_mod_time || is.na(full_cache_data)) {
#        cat(file=stderr(), "Loading cache.RData file.", "\n")
#        load(cache_path)
#        # TODO: See if it works if we omit this line
#        # full_cache_data <- full_cache_data[c("Danforth Sorghum Pilot", "KSU 2016", "MAC Season 1", "MAC Season 2", "MAC Season 3", "MAC Season 4", "MAC Season 6")]
#        cache_mod_time <- curr_mod_time
#        cat(file=stderr(), "Loading cache.RData file completed.", "\n")
#        return(full_cache_data)
#    } else {
#        cat(file=stderr(), "Latest cache.RData file already loaded.", "\n")
#        return(full_cache_data)
#    }
#}

# directory containing full-field images
image_dir <- '~/data/terraref/sites/ua-mac/Level_2/rgb_fullfield/_thumbs'
# dates that have full-field images
image_dates <- as.Date(unique(unlist(str_extract_all(list.files(image_dir), '[0-9]{4}-[0-9]{2}-[0-9]{2}'))))
  

# set page UI
ui <- fluidPage(theme = shinytheme('flatly'),
  tags$link(rel = 'stylesheet', type = 'text/css', href = 'style.css'),
  title = 'TERRA-REF Experiment Data',
  tags$img(src = 'logo.png', class = 'push-out'),
  # destination for all dynamic UI elements
  uiOutput('page_content')
)

# render UI for a given subexperiment
render_subexp_ui <- function(subexp_name, exp_name) {
  
  id_str <- paste0(exp_name, '_', subexp_name)
  
  tabPanel(subexp_name,
    
    sidebarPanel(class = 'push-down',
      uiOutput(paste0('variable_select_', id_str)),
      uiOutput(paste0('cultivar_select_', id_str))
    ),
     
    uiOutput(paste0('plot_hover_info_', id_str)),
    
    mainPanel(class = 'main-panel',
    
    tabsetPanel(
        tabPanel('Plot',
          div(class = 'push-down',
            plotOutput(paste0('trait_plot_', id_str), 
                        hover = hoverOpts(id = paste0('plot_hover_', id_str)))
          ),
          hr(),
          uiOutput(paste0('mgmt_select_info_', id_str)),
          timevisOutput(paste0('mgmt_timeline_', id_str))
        ),
        tabPanel('Map',
          div(class = 'map-container push-out',
            uiOutput(paste0('map_date_slider_', id_str)),
            htmlOutput(paste0('scan_options_table_', id_str)),
            leafletOutput(paste0('site_map_', id_str), width = '350px', height = '700px')
          )
        )
      )
    )
  )
}

render_experiment_ui <- function(exp_name, full_cache_data) {
  
  subexp_tabs <- lapply(names(full_cache_data[[ exp_name ]]), render_subexp_ui, exp_name)
  
  do.call(tabPanel, list(exp_name, div(class = 'push-down'),
    do.call(tabsetPanel, subexp_tabs))
  )
}

# render selection menu from available variables in a given subexperiment
render_variable_menu <- function(subexp_name, id_str, output, full_cache_data) {
  
  variable_names <- names(full_cache_data[[ subexp_name ]][[ 'trait_data' ]])
  
  output[[ paste0('variable_select_', id_str) ]] <- renderUI({
    selectInput(paste0('selected_variable_', id_str), 'Variable', variable_names)
  })
}

# render selection menu from available cultivars in a given subexperiment, for the selected variable
render_cultivar_menu <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  output[[ paste0('cultivar_select_', id_str) ]] <- renderUI({
    
    req(input[[ paste0('selected_variable_', id_str) ]])
    
    trait_records <- full_cache_data[[ subexp_name ]][[ 'trait_data' ]][[ input[[ paste0('selected_variable_', id_str) ]] ]][[ 'traits' ]]
    unique_cultivars <- unique(trait_records[[ 'cultivar_name' ]])
    
    selectInput(paste0('selected_cultivar_', id_str), 'Cultivar', c('None', unique_cultivars))
  })
}

# render box plot time series from trait records in a given subexperiment, for the selected variable
# if a cultivar is selected, render line plot from trait records for that cultivar
render_trait_plot <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  output[[ paste0('trait_plot_', id_str) ]] <- renderPlot({
    
    req(input[[ paste0('selected_variable_', id_str) ]])
    req(input[[ paste0('selected_cultivar_', id_str) ]])
    
    selected_subexp_data <- full_cache_data[[ subexp_name ]]
    selected_variable <- input[[ paste0('selected_variable_', id_str) ]]
    selected_cultivar <- input[[ paste0('selected_cultivar_', id_str) ]]
    
    plot_data <- selected_subexp_data[[ 'trait_data' ]][[ selected_variable ]][[ 'traits' ]]
    data_max <- max(plot_data[[ 'mean' ]])
    
    units <- selected_subexp_data[[ 'trait_data' ]][[ selected_variable ]][[ 'units' ]]
    title <- ifelse(units == '', selected_variable, paste0(selected_variable, ' (', units, ')'))
    
    unique_vals <- unique(plot_data[[ 'mean' ]])
    all_vals_integers <- all(unique_vals %% 1 == 0)
    num_unique_vals <- length(unique_vals)

    plot_data$method[is.na(plot_data$method) | plot_data$method == 'NA'] <- 'Not Provided'

    trait_plot <- ggplot(data = plot_data, aes(x = as.Date(date), y = mean, color = method)) +
      scale_colour_brewer(palette = "Set1")

    {
        if ((num_unique_vals < 20) & (max(unique_vals) < 30) & all_vals_integers) {
          trait_plot <- trait_plot + 
            geom_count() + 
            geom_vline(aes(xintercept = as.numeric(as.Date(date))),
                       color = 'grey')
        } else {
          trait_plot <- trait_plot + 
            geom_violin(scale = 'width', width = 1, aes(group = as.Date(date))) +
            geom_boxplot(outlier.alpha = 0.25, width = 0.2, aes(group = as.Date(date)))
        }
      }
      
    if (selected_cultivar != 'None') {
        title <- paste0(title, '\nCultivar ', selected_cultivar, ' in red')
        trait_plot <- trait_plot + 
          geom_point(data = subset(plot_data, cultivar_name == selected_cultivar), 
                     aes(x = as.Date(date), y = mean, group = site_id)) +
          geom_line(data = subset(plot_data, cultivar_name == selected_cultivar), 
                     size = 0.5, alpha = 0.5, aes(x = as.Date(date), y = mean, group = site_id)) 
    }
    
    trait_plot + 
      labs(
        title = paste0(title, '\n'),
        x = "Date",
        y = units
      ) +
      theme_bw() + 
      theme(text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1)) +
      xlim(as.Date(selected_subexp_data[[ 'start_date' ]]), as.Date(selected_subexp_data[[ 'end_date' ]])) +
      ylim(0, data_max)
  })
}

# render timeline from management records in a given subexperiment
render_mgmt_timeline <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  output[[ paste0('mgmt_timeline_', id_str) ]] <- renderTimevis({
    
    management_data <- full_cache_data[[ subexp_name ]][[ 'managements' ]]
    
    if (nrow(management_data) > 0) {
      
      types <- management_data[[ 'mgmttype' ]]
      dates <- management_data[[ 'date' ]]
      
      timeline_data <- data.frame(
        id = 1:nrow(management_data),
        content = types,
        start = dates
      )
      
      timevis(
        timeline_data,
        options = list(zoomable = FALSE)
      )
    }
  })
}

# render info box for date and value of cursor when hovering box/line plot
render_plot_hover <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  output[[ paste0('plot_hover_info_', id_str) ]] <- renderUI({
    
    req(input[[ paste0('plot_hover_', id_str) ]])
    
    hover <- input[[ paste0('plot_hover_', id_str) ]]
    
    wellPanel(class = 'plot-hover-info push-down',
      HTML(paste0(
        'Date', '<br>',
        toString(
          as.Date(hover$x, origin = lubridate::origin)
        ),
        '<br><br>',
        'Value', '<br>',
        format(round(hover$y, 2))
      ))
    )
  })
}

# render info box for date, type, and notes of selected (clicked) timeline item
render_timeline_hover <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  output[[ paste0('mgmt_select_info_', id_str) ]] <- renderUI({
    
    req(input[[ paste0('mgmt_timeline_', id_str, '_selected') ]])
    selected <- input[[ paste0('mgmt_timeline_', id_str, '_selected') ]]
    
    management_data <- full_cache_data[[ subexp_name ]][[ 'managements' ]]
    selected_record <- management_data[ as.numeric(selected), ]
    
    formatted_notes <- ''
    if (selected_record[[ 'notes' ]] != '') {
      formatted_notes <- paste0('<br><br>', selected_record[[ 'notes' ]])
    }
      
    
    wellPanel(class = 'mgmt-select-info',
      HTML(paste0(
        selected_record[[ 'mgmttype' ]], '<br>',
        selected_record[[ 'date' ]],
        formatted_notes
      ))
    )
  })
}

render_map <- function(subexp_name, id_str, input, output, full_cache_data) {
  
  # render slider input from dates in a given subexperiment
  output[[ paste0('map_date_slider_', id_str) ]] <- renderUI({
    
    req(input[[ paste0('selected_variable_', id_str) ]]) 
    req(input[[ paste0('selected_cultivar_', id_str) ]])
    
    selected_variable <- input[[ paste0('selected_variable_', id_str) ]] 
    selected_cultivar <- input[[ paste0('selected_cultivar_', id_str) ]]
    
    traits <- full_cache_data[[ subexp_name ]][[ 'trait_data' ]][[ selected_variable ]][[ 'traits' ]]
    
    if (selected_cultivar != 'None'){
      traits <- subset(traits, cultivar_name == selected_cultivar)
    }
    
    #traits_image_dates <- image_dates[image_dates %in% as.Date(unique(traits$date))] # to remove
    
    sliderInput(paste0('map_date_', id_str), 'Date',
                min(as.Date(traits$date)),
                max(as.Date(traits$date)),
                min(as.Date(traits$date)))
    
    #sliderTextInput(inputId = paste0('map_date_', id_str),
    #                label = 'Date',
    #                choices = traits_dates) # to remove
    
  })
  
  output[[ paste0('scan_options_table_', id_str) ]] <- renderText({
    
    req(input[[ paste0('selected_variable_', id_str) ]]) 
    req(input[[ paste0('selected_cultivar_', id_str) ]])
    req(input[[ paste0('map_date_', id_str) ]]) 
    
    selected_variable <- input[[ paste0('selected_variable_', id_str) ]] 
    selected_cultivar <- input[[ paste0('selected_cultivar_', id_str) ]]
    render_date <- input[[ paste0('map_date_', id_str) ]]
    
    traits <- full_cache_data[[ subexp_name ]][[ 'trait_data' ]][[ selected_variable ]][[ 'traits' ]]
    
    if (selected_cultivar != 'None'){
      traits <- subset(traits, cultivar_name == selected_cultivar)
    }
    
    # display scan options if selected date has/have fullfield images
    if(render_date %in% image_dates){
      image_paths <- grep(render_date, list.files(image_dir), value = TRUE)
      image_scan <- unlist(str_match_all(image_paths,
                                         'rgb_fullfield_L2_ua-mac_[0-9]{4}-[0-9]{2}-[0-9]{2}_(.*)_rgb_thumb\\.tif'))
      scan_options <- image_scan[-grep('\\.tif', image_scan)]
      scan_options_clean <- str_replace_all(scan_options, '_', ' ')
      scan_options_df <- data.frame(scan_number = 1:length(scan_options_clean),
                                    scan_name = scan_options_clean)
      scan_options_kable <- kable(scan_options_df) %>% kable_styling()
    }else{
      return()
    }
    
  })
  
  # render heat map of sites from trait records in a given subexperiment, for the selected date, variable and cultivar
  output[[ paste0('site_map_', id_str) ]] <- renderLeaflet({
    
    print('In renderingLeafLet')
    req(input[[ paste0('selected_variable_', id_str) ]])
    req(input[[ paste0('selected_cultivar_', id_str) ]])
    req(input[[ paste0('map_date_', id_str) ]])
    
    selected_variable <- input[[ paste0('selected_variable_', id_str) ]]
    selected_cultivar <- input[[ paste0('selected_cultivar_', id_str) ]]
    render_date <- input [[ paste0('map_date_', id_str) ]]
    
    traits <- full_cache_data[[ subexp_name ]][[ 'trait_data' ]][[ selected_variable ]][[ 'traits' ]]
    
    if (selected_cultivar != 'None'){
      traits <- subset(traits, cultivar_name == selected_cultivar)
    }
      
    
    units <- full_cache_data[[ subexp_name ]][[ 'trait_data' ]][[ selected_variable ]][[ 'units' ]]
    if (units != '') {
      units <- paste0('(', units, ')')
    }
      
    legend_title <- paste0(selected_variable, ' ', units)
    
    if(render_date %in% image_dates){
      image_paths <- grep(render_date, list.files(image_dir), value = TRUE)
      render_site_map(traits, render_date, legend_title, image_paths)
    }else{
      render_site_map(traits, render_date, legend_title)
    }
  })
}

# render outputs for a given subexperiment
render_subexp_output <- function(subexp_name, exp_name, input, output, full_cache_data) {
  
  id_str <- paste0(exp_name, '_', subexp_name)
  
  render_variable_menu(subexp_name, id_str, output, full_cache_data)
  
  render_cultivar_menu(subexp_name, id_str, input, output, full_cache_data)
  
  render_trait_plot(subexp_name, id_str, input, output, full_cache_data)
  
  render_plot_hover(subexp_name, id_str, input, output, full_cache_data)
  
  if (!is.null(full_cache_data[[ subexp_name ]][[ 'managements' ]])) {
    
    render_mgmt_timeline(subexp_name, id_str, input, output, full_cache_data)
    
    render_timeline_hover(subexp_name, id_str, input, output, full_cache_data)
    
  }

  render_map(subexp_name, id_str, input, output, full_cache_data)
}

render_experiment_output <- function(experiment_name, input, output, full_cache_data) {
  lapply(names(full_cache_data[[ experiment_name ]]), render_subexp_output, experiment_name, input, output, full_cache_data[[ experiment_name ]])
}

server <- function(input, output) {
  
  # load 'full_cache_data' object from cache file
  #full_cache_data <- load_cache(full_cache_data) 
  load('cache_full.RData') # use when testing - comment out cache chunk on top
  full_cache_data <- full_cache_data["MAC Season 6"] # use when testing - comment out cache chunk on top

  # render UI for all available experiments
  output$page_content <- renderUI({
    subexp_tabs <- lapply(names(full_cache_data), render_experiment_ui, full_cache_data)
    do.call(tabsetPanel, subexp_tabs)
  })
  
  # render outputs for all available experiments
  lapply(names(full_cache_data), render_experiment_output, input, output, full_cache_data)
}

shinyApp(ui = ui, server = server)
